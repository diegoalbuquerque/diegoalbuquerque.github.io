<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>Brincando com o Pequeno Endian&nbsp;|&nbsp;www.offensivethink.com</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="Brincando com o Pequeno Endian">
  
    <meta name="description" content="Duas formas de escrever strings, ou uma sequência de bytes, em memória, respeitando o Little endian. ">
    <meta property="og:description" content="Duas formas de escrever strings, ou uma sequência de bytes, em memória, respeitando o Little endian. ">
  
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="referencia-rapida.html">
        <div class="Navbar__Btn">
          
          <span>→ Referência rápida ← </span>
        </div>
      </a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="contacts.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F12e48681-f6a0-41cb-aa1f-73a46f35c5d3%2FOffensiveThink_Logo_Negative_notion_-_280x280.png?table=block&amp;id=ca933149-5245-4511-a885-9cf5922808e1"></span>&nbsp;
          
          <span>about &amp; contacts</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="offensivetools.html">
        <div class="Navbar__Btn">
          
          <span>Offensive Tools</span>
        </div>
      </a>
    
  
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
    <h1 class="Header__Title_post">Brincando com o Pequeno Endian</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Mon, Jan 4, 2021</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--gray">
            <a href="tag/bof.html">bof</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--yellow">
            <a href="tag/osce.html">osce</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--red">
            <a href="tag/binary-exploitation.html">binary-exploitation</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/541ac2e3917c46eba4abaffc917d1f5a" class="PageRoot"><div id="https://www.notion.so/5f4598f9062a4113a89c799e339badad" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Ao escrever um valor em uma região de memória (pilha) devemos nos preocupar em escrever de forma correta respeitando a convenção little endian ou big endian. </span></span></p></div><div id="https://www.notion.so/b7600945a59249c3ae883d1426ea2609" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/c31cf9a81ec04a72bdea3b7d95f2c4da" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Uma das formas de colocar valores na pilha é através da instrução assembly </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">push</code></span><span class="SemanticString">.  Ao utilizar o push devemos nos preocupar em inverter todos os bytes do valor que queremos escrever na memória e lembrar de respeitar a LIFO (Last In First Out), ou seja, também colocar os valores que queremos do final para o início. </span></span></p></div><div id="https://www.notion.so/44e0cd40d8194312b4d5c70d1d1a44e5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/0c2ad038ee064646b57a8f6302f6692e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Logo , se precisamos colocar a string /bin/sh na pilha, devemos lembrar que: </span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/a38a9aa4903a4ea2aad05197eb5910e2" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">A memória contém uma sequência de bytes. Para a CPU não existe o conceito de string, etc. O que ela reconhece são bytes. Uma string para um programa de alto nível nada mais é que uma seqência de bytes que termina com 0x00 (que conhecemos como NULL BYTE!)</span></span></li><li id="https://www.notion.so/62cbc979485e44dcb7b6bbb11888ac0c" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">O push, em 32 bits ( 32 bits / 8 bits = 4 bytes), coloca blocos de 4 em 4 bytes. Se você usa um push com menos de 4 bytes o assembler vai tratar de completar com NULL BYTES (0x00) o valor. Seria como se tívemos um campo que obrigatoriamente devemos colocar 4 números. Se colocarmos 9 o programa completará com zeros para ficar 0009. Logo um </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">push 0x01</code></span><span class="SemanticString">, se tornará um 0x00 00 00 01, formando assim 4 bytes. </span></span></li><li id="https://www.notion.so/111118dd4c2e43838403c776e5fd468c" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">Ao fazer um PUSH , o registrador ESP é decrementado de 4 bytes e os 4 bytes (arquitetura 32bits) passados são colocados no endereço de memória que o registrador ESP aponta no momento.  </span></span></li></ol><div id="https://www.notion.so/3f130521b9304bd4a9dccca3c7f31cb0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/6738ea7a824d45d2a3555856ae73c716" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Vamos observar na prática : </span></span></p></div><div id="https://www.notion.so/b84fffa11fc64d07a7703594d40e524d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">O código abaixo tem a finalidade de chamar a syscall execve passando para ela a string /bin/sh , que é o caminho do binário que ela deve executar. </span></span></p></div><pre id="https://www.notion.so/21b78eec04b94267928581fdbcad4f6f" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>[BITS <span class="token number">32</span>]

; nasm -f elf32 empilha-by-push.asm -o empilha-by-push.o
; ld -m elf_i386 empilha-by-push.o -o empilha-by-push
; gdb -q empilha-by-push


section .text

	<span class="token keyword">global</span> _start

	_start:

	xor eax,eax
	push eax         ; Insere NULL BYTES na pilha para indicar o fim da string

	; Insere na pilha /bin//sh , escrevendo de forma invertida 
  ; em blocos de <span class="token number">4</span> bytes
  ; python -c <span class="token string">"print '/bin//sh'.encode('hex')"</span>  => 2f62696e2f2f7368

	push <span class="token number">0x68732f2f</span>  ; hs//
  push <span class="token number">0x6e69622f</span>  ; nib/


  ; construcao dos parametros da execve
  mov ebx,esp      ; 1o <span class="token keyword">param</span> - endereco da string do comando a ser executado
  mov ecx,eax      ; 2o <span class="token keyword">param</span> - <span class="token number">0</span> = sem argumentos
  mov al,<span class="token number">0xb</span>       ; valor da syscall <span class="token punctuation">(</span><span class="token number">0xb</span> = <span class="token number">11</span> = execve<span class="token punctuation">)</span>
  int <span class="token number">0x80</span>         ; chama a syscall</span></span></span></code></pre><div id="https://www.notion.so/abef338870a140aebc48a1c6ef996633" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/3844336831394f5c84949fcec9019d65" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Vamos focar nos push&#x27;s. Bem a string (sequencia de bytes) que queremos colocar na memória é /bin//sh, em hexa : 2f 62 69 6e 2f 2f 73 68. </span></span></p></div><div id="https://www.notion.so/c73384e3e04148fc959060e99d0c9fb2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorRed"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">observação:</em></mark></span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"> colocamos duas barras após o bin e antes do sh para que possamos ter 8 bytes , facilitando assim o push. Lembra que o push coloca blocos de 4 bytes ?</em></span><span class="SemanticString"> </span></span></p></div><div id="https://www.notion.so/b926a1c153904481bb06e3c87a145608" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Observe que para escrever na memória devemos inverter os bytes e depois, agrupados em 4 bytes, colocar de forma de trás para frente, o que ficaria: </span></span></p><div class="Text__Children"><div id="https://www.notion.so/d98d857e5b524af795d52b9cb5c77d84" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">2f 62 69 6e 2f 2f 73 68 → 68 73 2f 2f  + 6e 69 62 2f</span></span></p></div></div></div><div id="https://www.notion.so/629c60cf16c84f14be035e9396fd7c41" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Montando os pushs então, colocando primeiro do último para o primeiro bloco, fica : </span></span></p><div class="Text__Children"><div id="https://www.notion.so/87be484f968b4130885fe470e6eff7c1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">push 0x68732f2f  ; hs//</code></span><span class="SemanticString">
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">push 0x6e69622f  ; nib/</code></span></span></p></div></div></div><div id="https://www.notion.so/b36ef99b4f9d42c696dfcaca1d516596" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Isso faz sentido mesmo ? Vamos ver no debug como isso se comporta. </span></span></p></div><div id="https://www.notion.so/aae3eca4f9794c829a7cba2697524bdf" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/abdc12901e2949768dfe45fd6be988ae" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fc02094ad-b6b8-4fd3-8e9a-137ae58b2409%2FUntitled.png?width=1425&amp;table=block&amp;id=abdc1290-1e29-4976-8dfe-45fd6be988ae"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fc02094ad-b6b8-4fd3-8e9a-137ae58b2409%2FUntitled.png?width=1425&amp;table=block&amp;id=abdc1290-1e29-4976-8dfe-45fd6be988ae" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/956eb50b04ba4c98b7f108fcb95e11c8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1b6ef59b61514e8b97497765072a6f1f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Bem no início da execução temos em (1) as instruções e em (2) e (3) o endereço onde o ESP está apontando, ou seja, o topo do pilha. </span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Observe e compare ao final. O endereço é o 0xffffd730.</strong></span><span class="SemanticString"> </span></span></p></div><div id="https://www.notion.so/70557a1c57064e4c960e29d2cdbe985d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/753dace7c4d1415e999d4a15d788b378" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Na tela abaixo, depois de executado os push&#x27;s temos:</span></span></p></div><div id="https://www.notion.so/775be68e27ef4d8e9abea754b9f1d862" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/067ef7b57ddb4852be5953100f737308" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">1 → Endereço do registrador ESP, que aponta para o topo da pilha (</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Observe que o endereço é o 0xffffd724 ou seja 12 bytes a menos que o inicial 0xffffd730</strong></span><span class="SemanticString">)</span></span></p><div class="Text__Children"><div id="https://www.notion.so/80b48fcebf764ad8904eb9aa2e6d9181" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">O endereço do ESP foi descolado 12 bytes &quot;para trás&quot;, devido os pushs. </span></span></p></div><div id="https://www.notion.so/f8d100a4a30e4376852c45f459f86745" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Pode haver uma certa confusão de como 0x...24 para 0x...30 tem 12 bytes e não apenas 6 bytes, afinal, 30 - 24 = 6, correto ? Ai que está, precisamos lembrar que estamos tratando do sistema de numeração hexadecimal ( que possui 16 símbolos - 0 1 2 3 4 5 6 7 8 9 A B C D E F ) mas temos como hábito usar o sistema decimal (que possui 10 símbolos - 0 1 2 3 4 5 6 7 8 9 ). </span></span></p></div><div id="https://www.notion.so/9a245ba2dc1a49c3913a225b09861d74" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Vejamos, usando nosso amigo python: </span></span></p></div><div id="https://www.notion.so/adb229b63a6243c290111303b22b9a13" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">python -c &quot;print(0xffffd730 - 0xffffd724)&quot;  → 12</code></span></span></p></div><div id="https://www.notion.so/16acdabf245c44eeb5cb4dd21a7776ab" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">python -c &quot;print(0x30 - 0x24)&quot; → 12</code></span></span></p></div><div id="https://www.notion.so/a2b48fd57eaf4e539a149413fca40671" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Mas como assim ?! Basta contar, lembrando que a contagem não deve ser &quot;vinta quatro&quot;, &quot;vinte cinco&quot;, &quot;vinte seis&quot; ... &quot;vinte nove&quot;, mas sim &quot;dois quatro&quot; , &quot;dois cinco&quot; , &quot;dois seis&quot; , ... , &quot;dois nove&quot; , &quot;dois , letra a&quot; , &quot;dois , letra b&quot; ...  Percebem a diferença ? Veja: </span></span></p></div><div id="https://www.notion.so/c94356af085d4d4fa81c351418af139d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">24 - 25 - 26 - 27 - 28 - 29 - 2A - 2B - 2C - 2D - 2E - 2F - 30  = 12 bytes de diferença entre o 24 (dois quatro ) e o 30 (três zero) </span></span></p></div></div></div><div id="https://www.notion.so/ce4a49ee8a5e4ff6af7e497b2ebb16df" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">2 → As instruç!oes que foram executadas ( os push&#x27;s )</span></span></p></div><div id="https://www.notion.so/2852f4e8a3274c6891bd0ef1d933c952" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">3 → A Pilha depois da execução dos push&#x27;s</span></span></p></div><div id="https://www.notion.so/9e6704e4a7154e8cbec531d20fb540aa" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">4 → Uma outra forma de ver o que tem no endereço de memória apontado pelo ESP, ou seja, uma outra forma de visualizar o conteúdo da pilha. </span></span></p></div><div id="https://www.notion.so/fc1dcc22a83d431884e18a5bdbb7468f" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F25871a54-12e0-4d52-a539-dcc6a34da22b%2FUntitled.png?width=1437&amp;table=block&amp;id=fc1dcc22-a83d-4318-84e1-8a5bdbb7468f"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F25871a54-12e0-4d52-a539-dcc6a34da22b%2FUntitled.png?width=1437&amp;table=block&amp;id=fc1dcc22-a83d-4318-84e1-8a5bdbb7468f" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/3bf795de09f44d97a39e0d5b1ab32501" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">O que observamos é: </span></span></p></div><div id="https://www.notion.so/f61d6a35534446c3b4cca6e44e087722" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Fizemos um push eax, que é zero, e foram colocados 4 bytes 0x00. Observe na imagem (4) que eles estão no final, na linha debaixo. Primeiros a entrar ficam embaixo da pilha. (LIFO!)</span></span></p></div><div id="https://www.notion.so/f8fbb4709fbc451cb9722ad0d1c50338" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">O próximo push é </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">push 0x68732f2f  ; hs//</code></span><span class="SemanticString"> , ou seja, o final da string, de trás pra frente. Agora olha que interessante nós passamos 68 73 2f 2f , no push. Mas observe como eles foram colocados na memória (4) na forma 2f 2f 73 68 ( / / s h ), ou seja, já de forma &quot;desinvertida&quot; </span></span></p></div><div id="https://www.notion.so/05a2f9fc560d487fa4074423ba770700" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">O próximo push é o </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">push 0x6e69622f  ; nib/</code></span><span class="SemanticString"> . Mais uma vez eles foram colocados na memória (4) na forma 2f 62 69 6e ( / b i n ), ou seja, já de forma &quot;desinvertiva&quot;</span></span></p></div><div id="https://www.notion.so/3f367f026edd430dbf3f0f8a616753ca" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Ao final, o ESP aponta para a região da memória que tem o primeiro caracter da string de forma correta , que é  o / (0x2f)</span></span></p></div><div id="https://www.notion.so/88a1405ba3574520aca71646709af9ff" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">O que acontece é que quando você escreve em blocos de bytes na memória a  &quot;CPU&quot; já trata de desinverter os blocos. Por isso que , se você tentar fazer um push sem inverter os bytes, eles serão colocados na memória de forma invertida. </span></span></p></div><div id="https://www.notion.so/9ce4c00822cf46b7bc18cf6f36a791aa" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Observe também que o PUSH, como colocado acima, fez com que o ESP se deslocasse para endereços menores. Foi de 0xFFFFD730 para 0xFFFFD724</span></span></p></div><div id="https://www.notion.so/66fac1919f0c41a7bafdd4c0b65daaee" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/f5dad4c93c00496392c3d6b76f8d7c42" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/f5dad4c93c00496392c3d6b76f8d7c42"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">E se for de byte em byte ?! </span></span></h3><div id="https://www.notion.so/9ce403f1bea841639fdefd8df35d7267" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/bdafd114e4b14f06887d01d4da69cf62" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Agora, isso também é verdade se escrevermos de byte em byte na pilha , ao invés de usar blocos de 4 bytes com as instruções push ? Vamos verificar. </span></span></p></div><div id="https://www.notion.so/7fd54f9221bd443abd76ea2f80f27931" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1f1bc38d03d0460dae2a22af0a57346e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Vamos ao código que terá a mesma finalidade do código anterior mas ao invés de usar PUSH vamos usar mov para colocar a string byte a byte na pilha. </span></span></p></div><div id="https://www.notion.so/5e38135031574b8ea6dd5541cd217d9d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><pre id="https://www.notion.so/78919015695b452ca6b6584ed8ae2929" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>[BITS 32]

section .text
	global _start

	_start:

		xor eax,eax            ; zera o eax que vai ser usado para 
													 ; definir o valor da syscall

    ; Colocando a string na pilha byte a byte em forma direto
		mov byte [esp],0x2f    ; /
		mov byte [esp+1],0x62  ; b
		mov byte [esp+2],0x69  ; i
		mov byte [esp+3],0x6e  ; n
		mov byte [esp+4],0x2f  ; / 
		mov byte [esp+5],0x73  ; s
		mov byte [esp+6],0x68  ; h
		mov byte [esp+7],0x00  ; NULL BYTE 
	
		; construcao dos parametros da execve
    mov ebx,esp        ; 1o param - endereco da string do comando 
											 ;            a ser executado
    mov ecx,eax        ; segundo parametro - 0 = sem argumentos
    mov al,0xb         ; valor da syscall (0xb = 11 = execve)
    int 0x80           ; chama a syscall</span></span></span></code></pre><div id="https://www.notion.so/556f33cdf8e043489b243760c072d7b5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/e84c4d07bffd4c55a7a12a92db97439b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Na imagem abaixo temos</span></span></p></div><div id="https://www.notion.so/a5df72d29a414d6ca53a60e37214893c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">1 → instruções responsáveis por escrever byte a byte na pilha</span></span></p></div><div id="https://www.notion.so/ee41462cb70146c7b0e06b8caad4406d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">2 → endereço apontado para o topo da pilha antes de começar a escrita ( 0xFFFFD730 ). Observe este valor de ESP do mesmo modo como fizemos quando observamos o código anterior que usava PUSH&#x27;s</span></span></p></div><div id="https://www.notion.so/49edd2a88e904b3b985b206deaf9422b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">3 → valores encontrados no endereço (pilha) apontado pelo ESP</span></span></p></div><div id="https://www.notion.so/6143a3649e204c9191e0df5d9a71fb05" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/d35e4b0ba9e143b69440cd1b674fffde" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F024395c3-dfcb-432d-baa3-f39f3aba1baf%2FUntitled.png?width=1421&amp;table=block&amp;id=d35e4b0b-a9e1-43b6-9440-cd1b674fffde"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F024395c3-dfcb-432d-baa3-f39f3aba1baf%2FUntitled.png?width=1421&amp;table=block&amp;id=d35e4b0b-a9e1-43b6-9440-cd1b674fffde" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/011c9a8696894efcb9ec40f32ef519ed" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Vamos executar o código passo a passo e verificar calmamente a escrita dos valores em memória. Observe o ESP e o conteúdo da pilha! </span></span></p></div><div id="https://www.notion.so/2d6652d6d4894bd794482d0a9db7601c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Executaremos inscrução por instrução usando o comando </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ni</code></span><span class="SemanticString"> (next instruction do gdb) e você deve observar na janela lateral o que está ocorrendo com o registrador ESP e o que está ocorrendo com a stack (pilha). </span></span></p></div><div id="https://www.notion.so/f58cc288de6e432e80f931169a21f653" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Usaremos ainda o comando </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">x/8b $esp</code></span><span class="SemanticString"> , para pedir que o gdb nos mostre 8 bytes a partir do endereço apontado pelo registrador ESP. </span></span></p></div><div id="https://www.notion.so/a14b387f529d4eb7b93d42c1974b47e0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/8b1a96a3fb494ba6a5dc9b3b14580753" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F3c46fb8e-9553-4555-bc45-9596900ac444%2FGEF-debug-empilha-by-mov.gif?width=1425&amp;table=block&amp;id=8b1a96a3-fb49-4ba6-a5dc-9b3b14580753"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F3c46fb8e-9553-4555-bc45-9596900ac444%2FGEF-debug-empilha-by-mov.gif?width=1425&amp;table=block&amp;id=8b1a96a3-fb49-4ba6-a5dc-9b3b14580753" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/9919fa6dc5dd4cecb3446e3a4233676b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/e3ebd15bb0a4457e87485fb843993f12" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/ad0fe73c5923476997a11f50a5443946" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Na primeira execução nada mudou no ESP nem na memória, afinal, apenas foi executado um </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">xor eax,eax</code></span><span class="SemanticString">, ou seja, zeramos o eax. </span></span></p></div><div id="https://www.notion.so/2eecc17d40ae4748b19679210c05d925" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">A partir da segunda instrução você verá que o conteúdo da pilha começa a ser modificado mas o ESP permanece inalterado, afinal, não estamos &quot;mexendo com ele&quot; apenas usando-o para apontar o local da memória onde queremos escrever. </span></span></p></div><div id="https://www.notion.so/f7e75436993d42b8930ab2505e1d1dd3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Observe ainda que o GEF tenta já interpretar os valores que estamos colocando na pilha e já começa a mostrar o /bin ...  só que em determinado momento (após os 4 bytes iniciais) ele &quot;se perde&quot; e depois se acha quando inserimos o NULL BYTE, fechando assim a string. </span></span></p></div><div id="https://www.notion.so/a40b2d68dc4d4546afa7272108bce146" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Observe que, desta forma, eu não preciso me preocupar em inverter os bytes , me preocupar com o LIFO, etc. Eu simplesmente mando escrever o byte que eu quero , na posição de memória que eu quero, e a CPU coloca lá. Não tem o que inverter, correto ? Afinal, estamos tratando de um byte apenas. </span></span></p></div><div id="https://www.notion.so/25e4d16c691a4aaa98022ffa60508e70" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Ao final, como podem observar, teremos o ESP também apontando para o início da nossa string desejada.  </span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Não mudou e apenas estamos escrevendo byte a byte a partir dele para frente!</strong></span></span></p></div><div id="https://www.notion.so/19c9a2c15bdf400c9b5c83974bfb96b2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/32ebaa288eee46ca98a72e9a7338d0ff" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorRed">Veja, esse código não deve ser utilizado assim, pois a escrita do ESP para regiões posteriores pode e vai sobrescrever dados na pilha</mark></strong></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorRed">.</mark></span><span class="SemanticString"> Se não fosse uma POC, deveríamos ter reservado espaço na pilha para escrever nossos dados, como é esperado. Isso pode ser feito , subtraindo a quantidade de bytes desejados  do ESP, fazendo ele se movimentar &quot;pra trás&quot;, ou seja, para endereços menores ( como acontece com o push) para então poder escrever os dados. O código ficaria: </span></span></p></div><div id="https://www.notion.so/88949960db164612848529f6eafcaa8b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><pre id="https://www.notion.so/66db5c07fa85406ba5c31f2280d17380" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>[BITS <span class="token number">32</span>]

section .text
	<span class="token keyword">global</span> _start

	_start:

		xor eax,eax        ; zera o eax que vai ser usado 
                       ; para definir o valor da syscall

		sub esp,<span class="token number">8</span>			   ; separando <span class="token number">8</span> bytes na pilha &lt;------

		mov byte [esp],<span class="token number">0x2f</span>    ; /
		mov byte [esp<span class="token number">+1</span>],<span class="token number">0x62</span>  ; b
		mov byte [esp<span class="token number">+2</span>],<span class="token number">0x69</span>  ; i
		mov byte [esp<span class="token number">+3</span>],<span class="token number">0x6e</span>  ; n
		mov byte [esp<span class="token number">+4</span>],<span class="token number">0x2f</span>  ; / 
		mov byte [esp<span class="token number">+5</span>],<span class="token number">0x73</span>  ; s
		mov byte [esp<span class="token number">+6</span>],<span class="token number">0x68</span>  ; h
		mov byte [esp<span class="token number">+7</span>],<span class="token number">0x00</span>  ; NULL BYTE 
	
		; construcao dos parametros da execve
    	mov ebx,esp      ; 1o <span class="token keyword">param</span> - endereco da string do comando 
    	mov ecx,eax      ; 2o <span class="token keyword">param</span> - <span class="token number">0</span> = sem argumentos
    	mov al,<span class="token number">0xb</span>       ; valor da syscall <span class="token punctuation">(</span><span class="token number">0xb</span> = <span class="token number">11</span> = execve<span class="token punctuation">)</span>
    	int <span class="token number">0x80</span>         ; chama a syscall</span></span></span></code></pre><div id="https://www.notion.so/834a91bd2ed6475681d7506766bc41f6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/f23cdc339efb48afb9c62700b8a1d93e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Vamos executar e ver o ESP voltando 8 bytes e depois escrever os bytes a partir deste novo ESP, evitando assim de sobrescrever dados essencias da pilha. </span></span></p></div><div id="https://www.notion.so/fb9b2d37c5a1404c8606d6c3c1353075" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/b7b085fd78894c138ebdb5c5a60784f3" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Ffe21c7e6-f8e1-4db6-97f3-8461f2edadb0%2FGEF-debug-empilha-by-mov-2.gif?width=1425&amp;table=block&amp;id=b7b085fd-7889-4c13-8ebd-b5c5a60784f3"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Ffe21c7e6-f8e1-4db6-97f3-8461f2edadb0%2FGEF-debug-empilha-by-mov-2.gif?width=1425&amp;table=block&amp;id=b7b085fd-7889-4c13-8ebd-b5c5a60784f3" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/339fb76f21c74361935b988549da6f35" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/f26d1e5adc494072946fedadc9c9e9a5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Observe que o ESP &quot;subiu&quot; abrindo espaço na pilha para escrita dos valores evitando assim sobrescrever possíveis dados essenciais. </span></span></p></div><div id="https://www.notion.so/9f85be02734f400f8f6a0a4b6f50394d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/8149a395d6e54e1c94a9debbce24e30e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">A idéia aqui é de estudar e melhorar o entendimento. Obviamente o segundo processo de escrever byte a byte toda a string desejada, apesar de nos livrar da preocupação de &quot;pensar invertido&quot;, consome muito mais opcodes e possivelmente ciclos de CPU. Em um processo de exploração , por exemplo, onde dependendo cada byte conta, não dá para abrir mão dos push&#x27;s e eles estão ai para serem usados. </span></span></p></div><div id="https://www.notion.so/9c8040bf9b204ce1bca714bb63eec736" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/bec5422f39114d88b8ae486edda9b704" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Em tempo, fica uma dica de um  script criado pelo grande Polverari (</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://blog.polverari.com.br/">https://blog.polverari.com.br/</a></span><span class="SemanticString">) que facilita demaisss na hora de montar os push&#x27;s &quot;invertidos&quot;</span></span></p></div><div id="https://www.notion.so/13f1e2e1a12e4f579137428e51ad2205" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><pre id="https://www.notion.so/8c690644f8004030bb79257f425c414e" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>&gt; echo -ne &quot;/bin//sh&quot; | rev | xxd -p | fold -w8 | awk &#x27;{print &quot;push 0x&quot;$1}&#x27;
push 0x68732f2f
push 0x6e69622f</span></span></span></code></pre><div id="https://www.notion.so/34c4422d9ce942c1834ee44dde5ee863" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/660af3b305e54767bb1cfbddc78393c3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">É isso, até a próxima. </span></span></p></div></article>
  <footer class="Footer">
  <script src="https://utteranc.es/client.js"
        repo="offensivethink-comments"
        issue-term="url"
        theme="github-dark-orange"
        crossorigin="anonymous"
        async>
</script>
  <div>&copy; www.offensivethink.com 2019-2021</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>