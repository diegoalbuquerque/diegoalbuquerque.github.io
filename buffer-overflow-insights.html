<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;üêû&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>Alguns aprendizados no caminho do Buffer Overflow&nbsp;|&nbsp;www.offensivethink.com</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="Alguns aprendizados no caminho do Buffer Overflow">
  
    <meta name="description" content="Alguns pontos de aten√ß√£o que fui aprendendo at√© agora no meu desenvolvimento em binary exploitation">
    <meta property="og:description" content="Alguns pontos de aten√ß√£o que fui aprendendo at√© agora no meu desenvolvimento em binary exploitation">
  
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;üêû&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="referencia-rapida.html">
        <div class="Navbar__Btn">
          
          <span>‚Üí Refer√™ncia r√°pida ‚Üê </span>
        </div>
      </a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="contacts.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F12e48681-f6a0-41cb-aa1f-73a46f35c5d3%2FOffensiveThink_Logo_Negative_notion_-_280x280.png?table=block&amp;id=ca933149-5245-4511-a885-9cf5922808e1"></span>&nbsp;
          
          <span>about &amp; contacts</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="offensivetools.html">
        <div class="Navbar__Btn">
          
          <span>Offensive Tools</span>
        </div>
      </a>
    
  
    
  
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
    <h1 class="Header__Title">Alguns aprendizados no caminho do Buffer Overflow</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Thu, May 20, 2021</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--red">
            <a href="tag/binary-exploitation.html">binary-exploitation</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--yellow">
            <a href="tag/osce.html">osce</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--pink">
            <a href="tag/oscp.html">oscp</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/04a20434b8ac449ab68eb8e77d3e6dae" class="PageRoot"><div id="https://www.notion.so/459aa6e017db4d3aa831081f3f795a75" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Quando voltei a estudar sobre explora√ß√£o de bin√°rios tive grandes mestres que me ensinaram muito e a medida que ia lendo e estudando o mesmo assunto, milhares de vezes, em perspectivas diferentes, aqui e acol√° ia me deparando com &quot;detalhes&quot; que achei que deveria anotar e internalizar. Notei que, est√£o neles, a diferen√ßa entre conseguir ou n√£o conseguir uma explora√ß√£o. </span></span></p></div><div id="https://www.notion.so/c1c4b4f7614b49ed99f47fd4e98a22c9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Estes detalhes est√£o na base que as vezes ignoramos. Os conceitos. Algumas vezes at√© acabamos nos atendo a seguir um roteiro que ir√° funcionar em 99,9% das vezes mas com isso deixamos de perceber os detalhes e sem os detalhes nos vemos sem entender porque um buffer overflow que deveria ser simples, do tipo vanilla, at√© mesmo sem prote√ß√£o alguma, n√£o funciona! </span></span></p></div><div id="https://www.notion.so/765780e747be4814a39e475f81aaaf30" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Relatei um pouco disso no meu artigo </span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">&quot;a escolha do pattern importa?&quot;</strong></span><span class="SemanticString">  , e agora coloco outros pontos de aten√ß√£o que acho que pode ser de ajuda para algu√©m mas que tamb√©m me servir√° como fonte de eterna consulta. </span></span></p></div><div id="https://www.notion.so/e73c0157d35447c3827dfbcd585dfeee" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/498ff4f82ab64b9283af7f89933f6ee6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorRed"><span class="SemanticString__Fragment SemanticString__Fragment--Unknown">Aten√ß√£o!</span></mark></span></span></p></div><div id="https://www.notion.so/bd3899d707334ec2bc847ddef825a5d9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">Por se tratar de um blog pessoal onde os artigos n√£o passam por revis√£o como em uma revista, livro ou outro material acad√™mico, v√°rios tipos de erros podem ocorrer. Pe√ßo sempre que analise, teste tudo que eu digo, duvide e o mais importante, se achar alguma inconsist√™ncia ou at√© mesmo uma melhor forma de escrever, por favor, entre em contato para que possamos corrigir e/ou melhorar</em></span></span></p></div><h2 id="https://www.notion.so/de6175a5edb04e13b5194821bd17df55" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/de6175a5edb04e13b5194821bd17df55"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">[ Bases! Decore a organiza√ß√£o da stack ] </span></span></h2><div id="https://www.notion.so/92f444afdc4946ca91626b347fec1b5a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">J√° que estamos tratando de buffer overflow na pilha √© fundamental que se conhe√ßa como ela se organiza, nem que seja minimamente. </span></span></p></div><div id="https://www.notion.so/e79770ee991a455486bd2ae4660e3465" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Toda fun√ß√£o tem um stack frame associado, que √© um  &quot;peda√ßo da pilha&quot; para guardar vari√°veis locais, ajudar as instru√ß√µes utilizadas pela CPU para algumas opera√ß√µes, etc. </span></span></p></div><div id="https://www.notion.so/63be161aaeec4913a8da26d2d81401d9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Um stack frame √© sempre colocado &quot;em cima&quot; de outro stack frame. O stack frame da fun√ß√£o que foi &quot;invocada&quot; fica &quot;em cima&quot; do stack frame da fun√ß√£o que a chamou. </span></span></p></div><div id="https://www.notion.so/37abe7fa3b564c0c9b102005448b842a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Essa √© a forma√ß√£o , digamos no caso de uma fun√ß√£o main() que chamou a funcao1()
</span></span></p></div><pre id="https://www.notion.so/ff6f04d5519e474f95eea57cb45e2f08" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>          +---------------------------------+                                     
    ESP -&gt;|                                 | Provavelmente onde voc√™ injetar√° seu
          |    Variaveis Locais  func1()    | payload                             
          |                                 |                                     
          |---------------------------------|                                     
  func1 -&gt;|                                 |                                     
   EBP    |    Stack Frame Pointer (SFP)    | Endere√ßo do Stack Frame Anterior!   
          |                                 |                                     
          |---------------------------------|                                     
          |                                 |                                     
          |  Return Address ( goes to EIP ) | Endere√ßo da instru√ß√£o para qual a   
          |                                 | CPU deve retornar! Em um Vanilla,   
          |                                 | o que voc√™ quer controlar!          
          |---------------------------------|                                     
          |      Par√¢metros da func1()      |                                     
          |                                 |                                     
          |---------------------------------|                                     
          |                                 |                                     
          |    Variaveis Locais main()      |                                     
          |                                 |                                     
          |           .                     |                                     
          |           .                     |                                     
          |           .                     |                                                                
          +---------------------------------+</span></span></span></code></pre><div id="https://www.notion.so/3d47657cd4924a2580fc7a1737918bec" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/40ee22eb91c949c2b0545db4386dc4ad" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Em assembly n√£o existe o conceito de vari√°vel, podemos dizer que tudo est√° em algum lugar da mem√≥ria, neste caso, estamos falando em endere√ßos da Stack! </span></span></p></div><div id="https://www.notion.so/ca37095cda584c60bcb6f4e474f210f8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">O acesso ao valor destas vari√°veis e aos par√¢metros da fun√ß√£o s√£o, em assembly, </span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">acesso a endere√ßos de mem√≥ria a partir da base da stack frame da fun√ß√£o</strong></span><span class="SemanticString">, ou seja, um deslocamento a partir de EBP.</span></span></p></div><div id="https://www.notion.so/6da7e26c73de4cae8c19b18d36629f5b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/3c86ebfb601843d8aa05998e97acc36c" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/3c86ebfb601843d8aa05998e97acc36c"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">[ Bases! Voc√™ n√£o sobrescreve o EIP ] </span></span></h2><div id="https://www.notion.so/99bdd3192fdb406cbeefee0e090be7d9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Este √© apenas um detalhe &quot;sint√°tico&quot; digamos assim. N√≥s n√£o sobrescrevemos o EIP, n√≥s sobrescrevemos uma √°rea da mem√≥ria que est√° na pilha. Ao sobrescrever esta √°rea esperamos que, continuando o fluxo de execu√ß√£o do programa, &quot;em algum momento&quot; (quando a instru√ß√£o ret for executada para sair da fun√ß√£o atual, por exemplo) este valor seja colocado em EIP (pela CPU) e isso desviar√° o fluxo do programa para onde queremos (no geral, nosso shellcode!)</span></span></p></div><div id="https://www.notion.so/f338341b9cb34ab6a34247376adcfe42" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">N√£o h√° problema em falar vamos sobrescrever o EIP, mas acho que sem esse entendimento consolidado na cabe√ßa, durante um tempo fiquei, por exemplo, procurando outras maneiras de escrever diretamente no EIP, e isso n√£o √© poss√≠vel! </span></span></p></div><div id="https://www.notion.so/a7f2404bfbb64595b9f46442839c57a1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/983e263ca55c4b739302b6385bed46ef" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/983e263ca55c4b739302b6385bed46ef"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">[ BASES! Cada endere√ßo de mem√≥ria guarda 1 byte ]</span></span></h2><div id="https://www.notion.so/2266c6da3e594071bd10a2ce5fbc3dde" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">√â importante perceber que apesar do debugger nos mostrar uma representa√ß√£o da mem√≥ria de 4 e 4 bytes (32 bits) ou 8 em 8 bytes (64 bits), cada endere√ßo de mem√≥ria guarda apenas 1 byte! Note que isso est√° &quot;expl√≠cito&quot; no debugger quando observamos que os endere√ßos s√£o incrementados de 4 em 4 bytes. </span></span></p></div><pre id="https://www.notion.so/79e36f6ddeb4447ab3aded5a32bd95af" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>0xFFFFD600   00000000
0xFFFFD604   00000000
0xFFFFD608   ffffd638   
0xFFFFD60C   5655621b  </span></span></span></code></pre><h2 id="https://www.notion.so/a14f1d11fe3748ef957b19bf9630ac02" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/a14f1d11fe3748ef957b19bf9630ac02"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">[ BASES! √â da direita para a esquerda ]</span></span></h2><div id="https://www.notion.so/fc8846c1585844e7a942e9be73f098f9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/5a1f0f1e05654902b5003ea91da814c6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Primeiro de tudo, </span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">n√≥s s√≥ escrevemos na mem√≥ria 1 byte por vez</strong></span><span class="SemanticString">! Memos que enviemos 3000 A&#x27;s , eles ser√£o escritos um por vez! </span></span></p></div><div id="https://www.notion.so/e6d8df0789d34efca3829ed24f2f748a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">A representa√ß√£o do conte√∫do da mem√≥ria , em um debbuger, √© da direita para a esquerda, ou seja, quando escrevemos 0X42 (1 byte) no endere√ßo </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">0XFFFFD600</code></span><span class="SemanticString">, veja que ele vai parar mais a direita, pois essa √© a real posi√ß√£o do endere√ßo </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">0xFFFFD600</code></span></span></p></div><pre id="https://www.notion.so/833496ef16724f4db62d7b6ea3c49831" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>0xFFFFD600   00000042</span></span></span></code></pre><div id="https://www.notion.so/08f38f56754b4a67ac14c7c79abb269d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Se escrevemos agora 0x43 veja que ele vai parar antes do 0x42, ou seja, voltando da direita para a esquerda, pois essa √© a real posi√ß√£o do endere√ßo </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">0xFFFFD601</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/39ecf466e05b4d1e8c1907445d4227ff" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>0xFFFFD600   00004342</span></span></span></code></pre><div id="https://www.notion.so/643454a98e994edd827f52998cd9dde2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/ec1a9097e2c14fba8e1b3e196c4e69fc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorRed">Nas refer√™ncias r√°pidas, aqui no site,  coloquei um diagrama que mostra algo do tipo: </mark></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorRed"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.offensivethink.com/referencia-rapida.html">https://www.offensivethink.com/referencia-rapida.html</a></mark></span></span></p></div><div id="https://www.notion.so/ca4eb8232f924576bf153d7c90038c88" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/c72daae64cec448cbdb7c34139a77f0c" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/c72daae64cec448cbdb7c34139a77f0c"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">[ O Fuzz √© importante ] </span></span></h2><div id="https://www.notion.so/7a20e195a45d4955953571d584aa1097" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">N√£o √© s√≥ enviar uma quantidade suficientes de A&#x27;s que voc√™ conseguir√° atingir um overflow, mesmo que o campo seja vulner√°vel. </span></span></p></div><div id="https://www.notion.so/f220604c49f54548841e4a5ac3064336" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">As vezes a condi√ß√£o de overflow s√≥ √© atingida quando uma condi√ß√£o espec√≠fica de combina√ß√£o de caracteres √© enviada. </span></span></p></div><div id="https://www.notion.so/fc46ef0c8732486ba6045e5385ef77f9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Podemos at√© imaginar uma situa√ß√£o onde a aplica√ß√£o filtre e n√£o permita um mesmo caracter seguidas vezes ( v√°rios A&#x27;s ) em um campo de password, por pol√≠ticas de seguran√ßa. Se este campo for vulner√°vel a um buffer overflow mas se testarmos apenas enviando A&#x27;s em tamanhos cada vez maiores, podemos nunca atingir a condi√ß√£o de overflow. </span></span></p></div><div id="https://www.notion.so/f7026ddf8e7f4c1b8208ce7a6c8ad983" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Dizem que fuzzing √© um assunto a parte que merece um estudo a parte. </span></span></p></div><h2 id="https://www.notion.so/af916d9163ed4dce843fe0baf9d49374" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/af916d9163ed4dce843fe0baf9d49374"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">[ O Pattern importa ] </span></span></h2><div id="https://www.notion.so/76cd7b55bb9b481587d5c34fddcf8092" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">D√™ uma olhada no artigo </span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">&quot;a escolha do pattern importa?&quot;</strong></span><span class="SemanticString">. </span></span></p></div><div id="https://www.notion.so/661eb04351604fadb3c292fc8eb905a3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Dependendo de como o bin√°rio foi escrito voc√™ pode conseguir atingir o overflow mas ter dificuldade de identificar o offset do ponto onde voc√™ tem que escrever na mem√≥ria para controlar, por exemplo, o EIP, SFP, SEH, etc.</span></span></p></div><div id="https://www.notion.so/7d610d888380461585009b153f4ee9d5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">As vezes ser√° necess√°rio &quot;contar&quot; manualmente no debug ou criar algum pattern personalizado para a situa√ß√£o. </span></span></p></div><div id="https://www.notion.so/f8948e87cf6a444b9a696b85502d5fea" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">O que acontece √© que um determinado bin√°rios pode ter alguns filtros para tratamento de uma determinada entrada vulner√°vel a buffer overflow mas que se voc√™ n√£o usar os caracteres certos pode n√£o conseguir estourar o buffer.  N√£o √© s√≥ enviar uma sequ√™ncia de A&#x27;s t√£o longa quanto poss√≠vel que far√° disparar uma poss√≠vel condi√ß√£o de overflow. </span></span></p></div><div id="https://www.notion.so/acd3863a536e4b7da5ac9384175a6c33" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Podemos ainda encontrar uma outra situa√ß√£o onde o programa pode ter alguma rotina de tratamento da sua entrada e os caracteres do seu pattern, na hora de voc√™ procurar o offset, podem ser transformados em outros caracteres ou mesmo &quot;exclu√≠dos&quot;, se comportando como badchars, logo voc√™ pode nunca atingir o overflow ou atingir o overflow mas n√£o conseguir definir bem o offset. </span></span></p></div><div id="https://www.notion.so/b709e14e4b974c52a24029473081198a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/c9aed80aad924de0b615ff339237f190" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/c9aed80aad924de0b615ff339237f190"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">[ O Tamanho do Buffer importa ] </strong></span></span></h2><div id="https://www.notion.so/a5ffac6721a1412499167e65157ee167" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">√â importante </span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">manter sempre as mesmas condi√ß√µes que causou overflow</strong></span><span class="SemanticString">, ou seja, se a aplica√ß√£o foi explorada com um payload de 800 bytes, podemos at√© tentar verificar se conseguimos colocar mais bytes na mem√≥ria, mas n√£o menos, mesmo que voc√™ n√£o venha a precisar de de todos os bytes.  </span></span></p></div><div id="https://www.notion.so/f695da391d9f494fa18597e9b5101af0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">A pilha √© din√¢mica logo qualquer mudan√ßa pode alterar o comportamento esperado. </span></span></p></div><div id="https://www.notion.so/2bb37c89a19e42269ee560a66330aff2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/386314c34eef464a8fa9bb40b288303e" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/386314c34eef464a8fa9bb40b288303e"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">[ Observe como seu payload est√° sendo escrito ] </span></span></h2><div id="https://www.notion.so/844d5d9005d5497488c5d03da90dc873" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Se a entrada de um buffer √© atrav√©s de uma fun√ß√£o gets(), ao final deste buffer a fun√ß√£o adicionar√° um byte 0x00 indicando que √© o final da string. </span></span></p></div><div id="https://www.notion.so/3aae5b1b87c544d2ba71a93ccdbf70ae" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Entender este tipo de comportamento √© importante para detectar as vezes o motivo de seu payload n√£o funcionar. </span></span></p></div><div id="https://www.notion.so/9c20cdd842b34e2fa5e07f5b061efeb8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Por exemplo, digamos que queremos sobrescrever o endere√ßo do SFP. Veja, </span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorRed">n√£o √© o EIP</mark></span><span class="SemanticString">.  </span></span></p></div><div id="https://www.notion.so/f7013963c49d463cbaadf83ed3b1c3c1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Lembrando que pela pilha temos:  </span></span></p></div><pre id="https://www.notion.so/a4a5d1a7dad54808aab453038030c0c6" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Vari√°veis Locais (N bytes)
SFP (4 bytes)
Return Address (4 bytes)</span></span></span></code></pre><div id="https://www.notion.so/20abfa3de5a64de2b0c15e7a9a068d17" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Vamos supor que o buffer seja de 8 bytes apenas e em seguida estaremos no ponto de sobrescrever o SFP.  Vamos supor que o estado da pilha seja: </span></span></p></div><pre id="https://www.notion.so/62d26a4bf425411eb1f49c88c78887c2" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>ESP -&gt;  0xFFFFD600   00000000
        0xFFFFD604   00000000
EBP -&gt;  0xFFFFD608   ffffd638  &lt;- endere√ßo do SFP (4 bytes)
        0xFFFFD60C   5655621b  &lt;- Return Address (4 bytes)</span></span></span></code></pre><div id="https://www.notion.so/8f51fd9ea22647fd878d233898279542" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Queremos que o o endere√ßo de mem√≥ria SFP seja sobrescrito com o endere√ßo </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">0xFFFFD604</code></span><span class="SemanticString">. Lembrando do little endian, precisaremos ent√£o enviar:  </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">AAAAAAAA\x04\xD6\xFF\XFF</code></span><span class="SemanticString">. </span></span></p></div><div id="https://www.notion.so/86a5e7420c474dfba7fd99d14dd2e8b8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Observe que, como a fun√ß√£o gets() adiciona o 0x00 ao final da string que enviamos, acabamos sobrescrevendo tamb√©m o return address, e com isso, voc√™ pode ter uma a√ß√£o inesperada que √© a aplica√ß√£o soltar para um ponto onde n√£o devia ou n√£o desejado:</span></span></p></div><pre id="https://www.notion.so/93707abe780844de934d60c72c29b35d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>ESP -<span class="token operator">></span>  0xFFFFD600   <span class="token number">42424242</span> <span class="token operator">&lt;</span>- AAAAA
        0xFFFFD604   <span class="token number">42424242</span> <span class="token operator">&lt;</span>- AAAAA
EBP -<span class="token operator">></span>  0xFFFFD608   FFFFD604  <span class="token operator">&lt;</span>- endere√ßo <span class="token keyword">do</span> SFP <span class="token punctuation">(</span><span class="token number">4</span> bytes<span class="token punctuation">)</span>
        0xFFFFD60C   <span class="token number">56556200</span>  <span class="token operator">&lt;</span>- modificado de <span class="token number">565562</span></span></span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorRed"><span>1b</span></mark></strong></span><span class="SemanticString"><span> para <span class="token number">565562</span></span></span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorRed"><span>00</span></mark></strong></span></span></code></pre><div id="https://www.notion.so/e19a5f4aaccc4457bd76a65d5301bf56" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/80feb920c2744651b67c69184d0fdb53" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/80feb920c2744651b67c69184d0fdb53"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">[ Olhe e entenda ] </strong></span></span></h2><div id="https://www.notion.so/35e0a31c86b34ffab14c590649111570" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Um dos passos na explora√ß√£o de um buffer overflow do tipo vanilla √© colocar no payload o endere√ßo de uma instru√ß√£o</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code"> jmp esp </code></span><span class="SemanticString"> que ir√° ser colocado no registrador EIP e com isso o fluxo da execu√ß√£o ser√° desviado para o payload. </span></span></p></div><div id="https://www.notion.so/b0c84b7b2ecd40719076e9f730e031d4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Fazemos isso, muitas vezes de forma autom√°tica, mas o que estamos assumindo √© que, ao chegar no momento da explora√ß√£o, o ESP conter√° o endere√ßo do nosso payload na mem√≥ria. </span></span></p></div><div id="https://www.notion.so/3775de1240914d439377edbbd909bc6f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Mas cont√©m mesmo ? E se o nosso payload estiver endere√ßado em outro registrador ? e se o ESP aponta para outro endere√ßo que n√£o o nosso payload ? Ser√° que o payload est√° correto ?</span></span></p></div><div id="https://www.notion.so/e7f010d1952548a685bbb9f362b9c5a5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Afinal, se o ESP n√£o &quot;aponta&quot; para o nosso shellcode, n√£o haver√° sucesso! </span></span></p></div><div id="https://www.notion.so/244275bb055d4ef5832c4f84858a645e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Logo, observe sempre os registradores e para onde eles apontam!  Observe onde seu payload, seu shellcode, est√° na pilha! </span></span></p></div><div id="https://www.notion.so/c300d4b3df0a4d2fa73db4a007e14a0b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/8e50ee3fe5f64a529519147806d2e046" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/8e50ee3fe5f64a529519147806d2e046"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">[ Olhe para o c√≥digo do seu shellcode ] </span></span></h2><div id="https://www.notion.so/40b90e54dbb74cb5b49f2f18398e6ede" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Muitas vezes usamos o msfvenom ou mesmo outros shellcodes j√° prontos para conseguir a explora√ß√£o. </span></span></p></div><div id="https://www.notion.so/d24b730011224a54a8ea06454ca188b1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Uma das t√©cnicas utilizadas na constru√ß√£o de alguns shellcodes consiste em mapear em que endere√ßo de mem√≥ria o c√≥digo est√° sendo executado para que se possa fazer saltos a partir dele. Escrevi um pouco sobre algumas das t√©cnicas no artigo &quot;</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">saltando sem jmp,call,pop&quot;</strong></span><span class="SemanticString">  da H2HC Magazine, 15a edi√ß√£o:</span></span></p></div><div id="https://www.notion.so/6169c83073c94518ba60b19cf36be9df" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/cbe9d53214934ce09ce330536041da15" class="Bookmark"><a href="https://github.com/h2hconference/H2HCMagazine/blob/master/RevistaH2HC_15.pdf"><p class="Bookmark__Link">https://github.com/h2hconference/H2HCMagazine/blob/master/RevistaH2HC_15.pdf</p></a></div><div id="https://www.notion.so/2944187cd1294ca3a204bbef9b39ca25" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"> </span></span></p></div><div id="https://www.notion.so/d0c6cdfece764596bd9e616eefc90d33" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Podemos observar que as t√©cnicas utilizam a pilha de alguma forma para armazenar o endere√ßo corrente e depois obt√™-lo atrav√©s de uma instru√ß√£o pop. </span></span></p></div><div id="https://www.notion.so/09019c3809bc44bf83fcade127a79070" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">O que acontece √© que algumas vezes, o c√≥digo inicial do shellcode, muitas vezes, um decrypt por exemplo, ao alterar a pilha acaba alterando tamb√©m o pr√≥prio shellcode , pois este tamb√©m est√° na pilha e ai n√£o entendemos porque conseguimos fazer um jmp esp, chegar no shellcode, mas ele n√£o executa! </span></span></p></div><div id="https://www.notion.so/40d069ca654344fbaf6f7dea7172b302" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Exemplo: √â &quot;comum&quot; encontrar em alguns shellcodes gerados pelo msfvenon com encrypta√ß√£o (x86/alpha_mixed) um c√≥digo do tipo:</span></span></p></div><pre id="https://www.notion.so/57836b1438d9438ab654e26568f73c36" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>FCMOVNB ST,ST<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
FSTENV <span class="token punctuation">(</span><span class="token number">28</span>-BYTE<span class="token punctuation">)</span> PTR DS:[EAX-C]
POP EBP</span></span></span></code></pre><div id="https://www.notion.so/3b83fbd784204994b609f23f5fb00a1d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Este conjunto de instru√ß√µes, que utiliza instru√ß√µes do processador aritm√©tico, que tem a finalidade de armazenar em EBP o endere√ßo da instru√ß√£o atual, como refer√™ncia de offset para v√°rios outros pontos do shellcode, acaba por, utilizando a pilha, sobrescrever parte do pr√≥prio shellcode que, est√° na pilha.</span></span></p></div><div id="https://www.notion.so/d0d32fdf4f2c4a2392d533e20944a44e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Neste caso, uma das solu√ß√µes consiste em, logo no in√≠cio do shellcode, inserir uma instru√ß√£o para  mover o ESP (</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sub esp,0x20</code></span><span class="SemanticString">) um pouco, a afim de que as altera√ß√µes na pilha feitas pelo c√≥digo (afinal escrevemos e alteramos a pilha atrav√©s de onde o ESP aponta) n√£o sobrescrevam o pr√≥prio shellcode </span></span></p></div><div id="https://www.notion.so/c927c27027f54d409b415b4e92aa449d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/0cdd1a5ada774c3191fd5c68680ba71d" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/0cdd1a5ada774c3191fd5c68680ba71d"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">[ Se der escolha caracteres &quot;print√°veis&quot; ] </span></span></h2><div id="https://www.notion.so/c880868155334536b7d830eb697dcfd0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Se puder escolha endere√ßos de instru√ß√µes ( jmp esp, pop pop ret, rop gadgets, etc. ) ou at√© mesmo codifique seu shellcode em caracteres print√°veis (ASCII PRINT)  (mais ou menos de 0x21 a 0x7e) pois isso pode ajudar a evitar badchars!   </span></span></p></div><div id="https://www.notion.so/700c08b7644e4dc98232de37e2c7d1af" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/c14a4a756d034972ad37bde56e4343f1" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/c14a4a756d034972ad37bde56e4343f1"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">[ N√£o se prenda. Salte para onde quiser ] </span></span></h2><div id="https://www.notion.so/9d80a5d58153438fbc3c77398a253aa2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/dc24e64722b548d188ec693a35995e65" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">√â comum usarmos um </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">jmp esp</code></span><span class="SemanticString"> na explora√ß√£o de um bof Vanilla ou um </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">pop pop ret </code></span><span class="SemanticString">em um um bof SEH, e ainda no seh pensar em fazer um </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">pop pop ret</code></span><span class="SemanticString"> que chegar√° no seu c√≥digo que far√° um jump 8 bytes pra frente ! Mas voc√™ pode saltar para onde quiser! Pode ser que, por exemplo, em um bof SEH, o espa√ßo antes da cadeia SEH j√° seja grande suficiente para colocar seu shellcode e por algum motivo ap√≥s seja bem pequeno. Ent√£o voc√™ pode saltar para tr√°s!  </span></span></p></div><div id="https://www.notion.so/f3c2ada519cf43c1882355793028a1a5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/1cb36645ee544e279cd930d6708fb7dc" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/1cb36645ee544e279cd930d6708fb7dc"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">[ O assembly pode ser modificado em runtime ]</span></span></h2><div id="https://www.notion.so/e4f4199100654da78a11c0fe7a87a030" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Lembre-se que a CPU monta seu c√≥digo assembly, digamos, de forma &quot;adapt√°vel&quot;, logo, voc√™ pode se aproveitar de bytes j√° presentes na mem√≥ria e alterando apenas o anterior ou o posterior , por exemplo, transformar aquela instru√ß√£o em outra. </span></span></p></div><div id="https://www.notion.so/52c966e517474e7cb597a5d08b28b17e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Digamos que voc√™ encontre o seguinte caso onde voc√™ consegue injetar c√≥digo em duas √°reas de mem√≥ria separadas apenas por um √∫nico byte : 0x2F ( uma /  ) , por exemplo. </span></span></p></div><div id="https://www.notion.so/0bb50c0938984a9eb45c826cc31dfec4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Em assembly 0x2F √© o opcode para a instru√ß√£o DAS ( </span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">Decimal Adjust AL after Subtraction </em></span><span class="SemanticString">)  - </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.felixcloutier.com/x86/das">https://www.felixcloutier.com/x86/das</a></span></span></p></div><div id="https://www.notion.so/7e0fe858446f4088afb516ceb93db816" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Se por algum motivo esta instru√ß√£o ao ser executada causa algum comportamento indesejado em seu shellcode ou mesmo na aplica√ß√£o, voc√™ pode evit√°-la, por exemplo, injetando logo antes dela um byte 0x6A. </span></span></p></div><div id="https://www.notion.so/cadb10ab111649b085af01ceae1e991d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Desta forma, a CPU entender√° que 0x6A2F significa </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">push 0x2f</code></span><span class="SemanticString">.</span></span></p></div><div id="https://www.notion.so/dfdbcd16b6844f9dade595c6ffe9e5ec" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Claro, se voc√™ tiver que manter o estado da pilha, poder√° ent√£o, logo no in√≠cio do seu shellcode, tentar voltar ao estado anterior com um </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">pop edi</code></span><span class="SemanticString">, por exemplo.</span></span></p></div><div id="https://www.notion.so/50a732cf9ab54812ac327ebc0042480e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/5b738eb17a7c4f92be005570f88dad97" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/5b738eb17a7c4f92be005570f88dad97"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">[ Use os registradores ]</span></span></h2><div id="https://www.notion.so/7c35b420a6934f0c8df0493a0c7e23c8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/6f8c6e179cac48df86dc338cfc46cb77" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">As vezes, por null byte ou alguma outra restri√ß√£o de bytes, voc√™ n√£o consegue inserir um jmp &lt;endere√ßo-shell-code&gt;. Observe para onde os registradores apontam. Se o ESP, por exemplo, apontar para um endere√ßo pr√≥ximo ao seu shell code, voc√™ pode tentar injetar, por exemplo,  um add esp, &lt;valor&gt; e jmp esp e conseguir o efeito desejado. </span></span></p></div><h2 id="https://www.notion.so/5f12d68c142945d894d48b130df10290" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/5f12d68c142945d894d48b130df10290"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">[ Comportamento Padr√£o! O que esperar!  ] </span></span></h2><div id="https://www.notion.so/087fe096c256437097bb85d656708bb8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">O que esperar na hora da explora√ß√£o. Estando atento ao que esperar podemos detectar poss√≠veis detalhes que est√£o fazendo n√£o conseguirmos explorar! </span></span></p></div><div id="https://www.notion.so/bc80f3b534524360a5f75f1583912416" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/ea70ea1988414eba940bd0c819feecec" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Unknown"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Bof Vanilla</strong></span></span></span></p></div><div id="https://www.notion.so/a3381fbe968b44bfb4d19d6266e12288" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">O que esperamos como padr√£o quando estamos explorando um Buffer overflow vanilla √©, na hora do stack overflow: </span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/8aa442cbb4f5421385a46f5d296821f4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">O registrador ESP aponta para o nosso payload! </span></span></li><li id="https://www.notion.so/a0a9878985e447ec96598045fd337fef" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">O EIP est√° com o endere√ßo que controlamos (inicialmente : 42424242 - AAAA)</span></span></li></ul><div id="https://www.notion.so/36e8b677f3924e8dac95be097584fa49" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Unknown"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Bof SEH </strong></span></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/748aba7c67a946e283b0401ab4b6a200" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">O endere√ßo do in√≠cio da cadeia SEH est√° no registrador FS no offset 0x0 ( FS[0] )</span></span></li><li id="https://www.notion.so/4c203c118fd540399c4fb9da7b6a7b4f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">O registrador ESP aponta para nosso payload</span></span></li><li id="https://www.notion.so/a04350f66a20422991d2891273ef9eda" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">O EIP est√° com o endere√ßo que controlamos (inicialmente : 42424242 - AAAA)</span></span></li><li id="https://www.notion.so/b55f71285e3b48f8bbb31f5a4e24fab5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Conseguimos sobrescrever a cadeia SEH ( immunity ‚Üí View ‚Üí SEH Chain )</span></span></li><li id="https://www.notion.so/056f5bf575e44e8dbf86858bd9d499e8" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Um peda√ßo do nosso payload est√° em ESP+8, por isso precisaremos de um POP (&quot;pula o endere√ßo em esp atual&quot;), POP (&quot;pula o endere√ßo do ESP+4&quot;), RET (obt√©m o endere√ßo em ESP+8 e coloca em EIP)</span></span></li></ul><div id="https://www.notion.so/939656646a5241e889910c5d13124bbe" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/6e5da6ce55bc4a1b82e4c5678f7dd2f0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/41ceec96572c488687ad6d6857772e05" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Por enquanto, √© isso.</span></span></p></div><div id="https://www.notion.so/fedbefbca3904db7b5b79249a2f4e6b1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/6fe7fb6063794f86b081f8ec9c341143" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/7f26fdbe73d3431bb60d398816c5f4f8" class="ColorfulBlock ColorfulBlock--ColorBrown Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">. </em></span></span></p></div><div id="https://www.notion.so/cd85ce53b8924c1b920b76898bddeaf8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/dd5c2a4aaad443c590da961352e0b1d7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/5adc4b5ff7b2483dbc1ee44c5a2cb7c8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/0e30a21980ef4945a2372797aa94de88" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/6aee1d7f589548c99bf16af36fb38d6a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/61fa45ca6e1842f3aba81d2dc8f89231" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></article>
  <footer class="Footer">
  <div>&copy; www.offensivethink.com 2024</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>

</body>

</html>